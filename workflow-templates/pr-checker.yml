name: GitHub PR Checker
permissions:
  contents: read
  pull-requests: write
on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  github-pr-check:
    runs-on: [self-hosted, acr]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- Step 0: Debug GITHUB_TOKEN (bash version) ---
      - name: Validate GITHUB_TOKEN
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ GITHUB_TOKEN is emptyâ€”check that Actions are enabled and permissions are correct."
            exit 1
          fi

          echo "ðŸ”‘ GITHUB_TOKEN loaded (length: ${#GITHUB_TOKEN} chars)"
          preview="${GITHUB_TOKEN:0:4}...${GITHUB_TOKEN: -4}"
          echo "ðŸ” GITHUB_TOKEN (preview): $preview"

      # --- Step 1: Build PR context + call backend (bash version) ---
      - name: Call backend and save artifacts
        id: backend_call
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_HTML_URL: ${{ github.event.pull_request.html_url }}
          REQUESTER_LOGIN: ${{ github.event.pull_request.user.login }}
          REPO_NAME: ${{ github.event.repository.name }}
          REPO_OWNER: ${{ github.repository_owner }}
          CREATOR_LOGIN: ${{ github.event.pull_request.user.login }}
          CREATOR_EMAIL: ${{ github.event.pull_request.user.email }}
          REQUESTED_REVIEWERS: ${{ toJson(github.event.pull_request.requested_reviewers) }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          # Check required context variables
          if [ -z "$PR_NUMBER" ] || [ -z "$GITHUB_REPOSITORY" ] || [ -z "$PR_HTML_URL" ]; then
            echo "âŒ Missing one of: PR_NUMBER, GITHUB_REPOSITORY, PR_HTML_URL."
            echo "Values: PR_NUMBER=$PR_NUMBER, GITHUB_REPOSITORY=$GITHUB_REPOSITORY, PR_HTML_URL=$PR_HTML_URL"
            exit 1
          fi

          echo "ðŸ”Ž PR context:"
          echo "  Repo:        $GITHUB_REPOSITORY"
          echo "  PR number:   $PR_NUMBER"
          echo "  PR URL:      $PR_HTML_URL"
          echo "  Requester:   $REQUESTER_LOGIN"

          repo_link="$PR_HTML_URL"

          creator_email="$CREATOR_EMAIL"
          if [ -z "$creator_email" ]; then
            creator_email="${CREATOR_LOGIN}@github.local"
          fi

          echo "ðŸ‘¤ Creator email: $creator_email"

          # Extract reviewer logins from JSON array
          reviewers_logins=$(echo "$REQUESTED_REVIEWERS" | jq -r '.[].login' 2>/dev/null | sort -u)
          if [ -z "$reviewers_logins" ]; then
            echo "ðŸ‘¥ Reviewer logins: None"
          else
            echo "ðŸ‘¥ Reviewer logins:"
            echo "$reviewers_logins" | while read -r reviewer; do
              echo "  â€¢ $reviewer"
            done
          fi

          # Encode fields by URL encoding spaces (%20), more encoding can be added if needed
          encoded_repo_link="${repo_link// /%20}"
          encoded_token="$GITHUB_TOKEN"
          encoded_creator_email="${creator_email// /%20}"
          encoded_creator_login="${CREATOR_LOGIN// /%20}"

          backend_url='https://10.100.48.16/api/review/github-pr/'
          echo "ðŸ“¨ Sending PR details to backend at: $backend_url"

          # Send POST request with form data to backend
          result=$(curl -k -X POST -sS \
            -F "repo_link=$encoded_repo_link" \
            -F "triggerPat=$encoded_token" \
            -F "r_effort=low" \
            -F "email=$encoded_creator_email" \
            -F "gitUser=$encoded_creator_login" \
            -F "prtype=active" \
            "$backend_url")

          echo "ðŸŒ Raw backend response: $result"
          
          # Parse JSON response with debug output
          run_id=$(echo "$result" | jq -r '.run_id' 2>/dev/null)
          echo "Parsed run_id: $run_id"
          
          creator=$(echo "$result" | jq -r '.prs.developer' 2>/dev/null)
          echo "Parsed creator: $creator"
          
          # Parse reviewers safely; if empty or null, set a default message
          reviewers=$(echo "$result" | jq -r '.prs.reviewers | join("\n")' 2>/dev/null)
          if [ -z "$reviewers" ] || [ "$reviewers" = "null" ]; then
            echo "No reviewers field found or empty in JSON."
            reviewers="No reviewers found"
          else
            echo "Parsed reviewers:"
            echo "$reviewers"
          fi
          
          # Validate run_id presence
          if [ -z "$run_id" ] || [ "$run_id" = "null" ]; then
            echo "âš ï¸ Missing run_id. Response:"
            echo "$result"
            exit 1
          fi

          artifact_dir="$GITHUB_WORKSPACE/artifacts"
          mkdir -p "$artifact_dir"

          echo "$run_id" > "$artifact_dir/run_id.txt"
          echo "$creator" > "$artifact_dir/creator.txt"
          echo "$reviewers" > "$artifact_dir/all_reviewers.txt"

          echo "âœ… Saved artifacts: run_id.txt, creator.txt, all_reviewers.txt"
          echo "ðŸŽ‰ Review URL: https://10.100.48.16/#/pr-review/$run_id/"

          echo "run_id=$run_id" >> $GITHUB_OUTPUT
          echo "artifactDir=$artifact_dir" >> $GITHUB_OUTPUT

      # --- Step 2: PR comment using GITHUB_TOKEN ---
      - name: Post PR comment with review URL
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = `${{ steps.backend_call.outputs.run_id }}`;
            const reviewUrl = `https://10.100.48.16/#/pr-review/${runId}/`;
            const prNumber = context.payload.pull_request.number;

            const body = [
              "**Automated PR Review** is ready!",
              "",
              `View it here: ${reviewUrl}`
            ].join("\n");

            core.info(`Posting PR comment to #${prNumber} with review URL: ${reviewUrl}`);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });
